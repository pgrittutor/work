<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TutorMate</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        :root {
            --primary-color: #007AFF; /* iOS Blue */
            --secondary-color: #F2F2F7; /* iOS Light Gray */
            --text-color: #1C1C1E;
            --text-secondary-color: #8A8A8E;
            --background-color: #FFFFFF;
            --separator-color: #E5E5EA;
        }
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--secondary-color); color: var(--text-color); }
        .app-container { display: flex; flex-direction: column; height: 100%; }
        .page { flex-grow: 1; overflow-y: auto; padding: 15px; display: none; }
        .page.active { display: block; }
        .page-header { padding: 10px 15px; background-color: var(--background-color); border-bottom: 1px solid var(--separator-color); }
        .page-header h1 { font-size: 24px; margin: 0; }
        .bottom-nav { display: flex; background-color: #F8F8F8; border-top: 1px solid var(--separator-color); }
        .nav-item { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: var(--text-secondary-color); }
        .nav-item.active { color: var(--primary-color); }
        
        /* List Styles */
        .list-group { margin: 15px 0; background: var(--background-color); border-radius: 10px; overflow: hidden; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--separator-color); cursor: pointer; }
        .list-item:last-child { border-bottom: none; }
        .list-item h3 { margin: 0; font-size: 17px; } .list-item p { margin: 0; color: var(--text-secondary-color); font-size: 15px; }
        
        /* FAB */
        .fab { position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px; background-color: var(--primary-color); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 28px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; z-index: 10; }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 99; display: none; }
        .modal-content { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--secondary-color); border-radius: 12px 12px 0 0; padding: 20px; box-sizing: border-box; transform: translateY(100%); transition: transform 0.3s ease-out; }
        .modal-content h2 { margin-top: 0; }
        .modal-overlay.active { display: block; }
        .modal-overlay.active .modal-content { transform: translateY(0); }
        
        /* Form Elements */
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #C6C6C8; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 14px; border: none; border-radius: 8px; background-color: var(--primary-color); color: white; font-size: 17px; font-weight: 600; }
        .btn-danger { background-color: #FF3B30; }

        /* Detail Page Tabs */
        .detail-tabs { display: flex; background: #EFEFF4; border-radius: 8px; padding: 3px; }
        .tab-button { flex: 1; padding: 8px; text-align: center; background: transparent; border: none; border-radius: 6px; font-weight: 600; color: var(--text-color); }
        .tab-button.active { background: var(--background-color); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); display: none; justify-content: center; align-items: center; z-index: 999; }
    </style>
</head>
<body>
    <div class="loader"><h3>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h3></div>

    <div class="app-container">
        <div id="classes-page" class="page active">
            <div class="page-header"><h1>‡∏Ñ‡∏•‡∏≤‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1></div>
            <div id="class-list-container"></div>
            <div class="fab" onclick="showAddClassModal()">+</div>
        </div>

        <div id="details-page" class="page">
            </div>
        
        <div id="dashboard-page" class="page">
             <div class="page-header"><h1>Dashboard</h1></div>
             </div>

        <nav class="bottom-nav">
            <div id="nav-classes" class="nav-item active" onclick="navigateTo('classes-page')">‡∏Ñ‡∏•‡∏≤‡∏™</div>
            <div id="nav-dashboard" class="nav-item" onclick="navigateTo('dashboard-page')">Dashboard</div>
        </nav>
    </div>

    <div id="form-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" id="modal-container">
            </div>
    </div>


<script>
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz1pojd2Zb0JfwT4fc9SzihZFi4axhagJQ7Xaomktc_fNG_1Rr07ZATeMzpDGxFodPy/exec'; // üîó ‡∏ß‡∏≤‡∏á URL ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    const loader = document.querySelector('.loader');
    let ALL_CLASSES_LIST = []; // Store only the class list for speed
    let CURRENT_CLASS_DETAILS = null; // Store details of the currently viewed class

    // --- Core & Navigation ---
    async function callGAS(action, payload = {}) {
        loader.style.display = 'flex';
        try {
            const response = await fetch(GAS_WEB_APP_URL, { method: 'POST', mode: 'cors', body: JSON.stringify({ action, payload }) });
            const result = await response.json();
            if (result.status === 'error') throw new Error(result.message);
            return result.data;
        } finally {
            loader.style.display = 'none';
        }
    }

    function navigateTo(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if (pageId === 'classes-page' || pageId === 'details-page') {
            document.getElementById('nav-classes').classList.add('active');
        } else {
            document.getElementById(`nav-${pageId.split('-')[0]}`).classList.add('active');
        }

        if (pageId === 'dashboard-page') loadDashboard();
    }
    
    // --- Initial Load ---
    window.onload = async () => {
        ALL_CLASSES_LIST = await callGAS('getClassesList');
        renderClassList();
    };

    // --- Class List Page ---
    function renderClassList() {
        const container = document.getElementById('class-list-container');
        container.innerHTML = `
            <div class="list-group" id="sortable-class-list">
                ${ALL_CLASSES_LIST.map(cls => `
                    <div class="list-item" data-class-id="${cls.classId}" onclick="loadClassDetails('${cls.classId}')">
                        <div><h3>${cls.className}</h3></div>
                        <span>&gt;</span>
                    </div>
                `).join('')}
            </div>`;
        initSortable();
    }
    
    function initSortable() {
        const el = document.getElementById('sortable-class-list');
        Sortable.create(el, {
            animation: 150,
            onEnd: async (evt) => {
                const classIds = Array.from(el.children).map(li => li.dataset.classId);
                await callGAS('updateClassOrder', { classIds });
            },
        });
    }

    async function loadClassDetails(classId) {
        CURRENT_CLASS_DETAILS = await callGAS('getClassDetails', { classId });
        if (!CURRENT_CLASS_DETAILS) return;
        renderDetailsPage();
        navigateTo('details-page');
    }

    // --- Details Page ---
    function renderDetailsPage() {
        const page = document.getElementById('details-page');
        const data = CURRENT_CLASS_DETAILS;
        page.innerHTML = `
            <div class="page-header" style="display:flex; justify-content:space-between; align-items:center;">
                <button style="width:auto; background:none; color:var(--primary-color); padding:0;" onclick="navigateTo('classes-page')">&lt; Back</button>
                <h1 style="text-align:center; flex-grow:1;">${data.className}</h1>
            </div>
            <div class="detail-tabs">
                <button id="tab-btn-students" class="tab-button active" onclick="switchTab('students')">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                <button id="tab-btn-logs" class="tab-button" onclick="switchTab('logs')">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
            </div>
            
            <div id="tab-content-students" class="tab-content active">
                <div class="list-group" id="student-list-container">
                    ${data.students.map(renderStudentItem).join('') || '<div class="list-item"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p></div>'}
                </div>
                <button onclick="showAddStudentModal()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
            </div>
            <div id="tab-content-logs" class="tab-content">
                <div class="list-group" id="log-list-container">
                     ${data.logs.map(renderLogItem).join('') || '<div class="list-item"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p></div>'}
                </div>
                <button onclick="showAddLogModal()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</button>
            </div>
        `;
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`tab-btn-${tabName}`).classList.add('active');
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`tab-content-${tabName}`).classList.add('active');
    }

    // --- Render Items ---
    function renderStudentItem(student) { /* ... implementation ... */ }
    function renderLogItem(log) { /* ... implementation ... */ }
    // These functions can be built similar to previous versions if needed

    // --- Modal Handling ---
    const modal = document.getElementById('form-modal');
    const modalContainer = document.getElementById('modal-container');

    function showModal(content) {
        modalContainer.innerHTML = content;
        modal.classList.add('active');
    }
    
    function closeModal(event) {
        if (event.target === modal || event.target.id === 'cancel-btn') {
            modal.classList.remove('active');
        }
    }
    
    function showAddClassModal() {
        showModal(`
            <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏≤‡∏™‡πÉ‡∏´‡∏°‡πà</h2>
            <input type="text" id="modal-className" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏≤‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
            <input type="text" id="modal-schedule" placeholder="‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
            <button onclick="addClass()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button id="cancel-btn" class="btn-secondary" style="margin-top:10px;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        `);
    }

    // --- Action Functions (e.g., addClass) ---
    async function addClass() {
        const className = document.getElementById('modal-className').value;
        const schedule = document.getElementById('modal-schedule').value;
        if (!className) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏≤‡∏™');
        
        const newClass = await callGAS('addClass', { className, schedule });
        if (newClass) {
            ALL_CLASSES_LIST.push(newClass);
            renderClassList();
            closeModal({target:modal}); // Close modal on success
        }
    }
    
    // ... Other functions like addStudent, addLog, edit, delete would follow this modal pattern ...

    // --- Dashboard Page ---
    async function loadDashboard() {
         const allLogs = await callGAS('getAllLogs');
         renderDashboard(allLogs);
    }
    function renderDashboard(logs) { /* ... implementation ... */ }

</script>
</body>
</html>
