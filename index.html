<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô V3</title>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f7f6; color: #333; margin: 0; display: flex; height: 100vh; }
        .sidebar { width: 280px; background-color: #2c3e50; color: white; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .main-content { flex-grow: 1; padding: 30px; overflow-y: auto; }
        h1, h2, h3 { color: #2c3e50; }
        h1 { margin-top: 0; }
        .sidebar h2 { color: #ecf0f1; margin-top: 0; }
        #class-list { list-style-type: none; padding: 0; }
        #class-list li { padding: 12px 15px; margin-bottom: 5px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; border-left: 4px solid transparent; }
        #class-list li:hover { background-color: #34495e; }
        #class-list li.active { background-color: #3498db; border-left-color: #ecf0f1; font-weight: bold; }
        .form-section, .class-details-card { margin-bottom: 25px; padding: 25px; border: 1px solid #ddd; border-radius: 8px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        input[type="text"], input[type="date"], textarea, button { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #3498db; color: white; font-weight: bold; cursor: pointer; border: none; }
        button:hover { background-color: #2980b9; }
        .btn-danger { background-color: #e74c3c; } .btn-danger:hover { background-color: #c0392b; }
        .btn-secondary { background-color: #95a5a6; } .btn-secondary:hover { background-color: #7f8c8d; }
        .editable-item { display: flex; align-items: center; justify-content: space-between; padding: 8px; border-radius: 4px; margin-bottom: 5px; background: #fdfdfd; border: 1px solid #eee; }
        .editable-item .content { flex-grow: 1; }
        .editable-item .actions { display: flex; gap: 5px; }
        .editable-item button { width: auto; padding: 5px 10px; font-size: 0.8em; }
        #welcome-message { text-align: center; color: #7f8c8d; padding: 50px; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

    <div class="sidebar">
        <h2>‡∏Ñ‡∏•‡∏≤‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
        <ul id="class-list"></ul>
        <hr>
        <div class="form-section" style="background: transparent; border:none; padding: 0; box-shadow: none;">
             <h3 style="color: white;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏≤‡∏™‡πÉ‡∏´‡∏°‡πà</h3>
             <input type="text" id="newClassName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏≤‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
             <input type="text" id="newSchedule" placeholder="‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
             <button id="addClassBtn">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏≤‡∏™</button>
        </div>
    </div>

    <div class="main-content">
        <div id="class-display">
            <div id="welcome-message">
                <h1>üëã ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö!</h1>
                <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏≤‡∏™‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>
            </div>
        </div>
    </div>

<script>
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz1pojd2Zb0JfwT4fc9SzihZFi4axhagJQ7Xaomktc_fNG_1Rr07ZATeMzpDGxFodPy/exec'; // üîó ‡∏ß‡∏≤‡∏á URL ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    let ALL_CLASSES_DATA = [];
    let currentClassId = null;

    // --- Core Functions ---
    async function callGAS(action, payload = {}) {
        document.body.style.cursor = 'wait';
        try {
            const response = await fetch(GAS_WEB_APP_URL, { method: 'POST', mode: 'cors', body: JSON.stringify({ action, payload }) });
            const result = await response.json();
            if (result.status === 'error') throw new Error(result.message);
            return result.data;
        } catch (error) {
            console.error('GAS Call Error:', error);
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            return null;
        } finally {
            document.body.style.cursor = 'default';
        }
    }

    window.onload = async () => {
        ALL_CLASSES_DATA = await callGAS('getClasses');
        renderClassList();
    };

    // --- Rendering Functions ---
    function renderClassList() {
        const classList = document.getElementById('class-list');
        classList.innerHTML = '';
        ALL_CLASSES_DATA.sort((a, b) => a.className.localeCompare(b.className)).forEach(cls => {
            const li = document.createElement('li');
            li.textContent = cls.className;
            li.dataset.classId = cls.classId;
            li.onclick = () => renderClassDetails(cls.classId);
            classList.appendChild(li);
        });
    }

    function renderClassDetails(classId) {
        currentClassId = classId;

        // Highlight active class in the list
        document.querySelectorAll('#class-list li').forEach(li => {
            li.classList.toggle('active', li.dataset.classId === classId);
        });
        
        const classData = ALL_CLASSES_DATA.find(c => c.classId === classId);
        if (!classData) return;

        const displayDiv = document.getElementById('class-display');
        displayDiv.innerHTML = `
            <h1>${classData.className}</h1>
            <div class="class-details-card">
                <h2>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                <input type="text" id="schedule-${classId}" value="${classData.schedule}">
                <button onclick="updateSchedule('${classId}')">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
            </div>
            <div class="class-details-card">
                <h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</h2>
                <div id="log-list-${classId}">
                    ${classData.logs.sort((a,b)=> new Date(b.date) - new Date(a.date)).map(log => renderLogItem(log)).join('')}
                </div>
                <hr>
                <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà</h3>
                <input type="date" id="newLogDate-${classId}">
                <textarea id="newLogContent-${classId}" placeholder="‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô..."></textarea>
                <button onclick="addLog('${classId}')">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
            <div class="class-details-card">
                <h2>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                <div id="student-list-${classId}">
                    ${classData.students.map(student => renderStudentItem(student)).join('')}
                </div>
                <hr>
                <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                <input type="text" id="newStudentName-${classId}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
                <button onclick="addStudent('${classId}')">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
            </div>
        `;
    }

    function renderStudentItem(student) {
        return `
            <div class="editable-item" id="student-${student.id}">
                <span class="content">${student.name}</span>
                <div class="actions">
                    <button onclick="editStudent('${student.id}', '${student.name}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button class="btn-danger" onclick="deleteStudent('${student.id}')">‡∏•‡∏ö</button>
                </div>
            </div>`;
    }

    function renderLogItem(log) {
        // Format date for display if it's a valid date string
        const displayDate = new Date(log.date).toLocaleDateString ? new Date(log.date).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' }) : log.date;
        return `
            <div class="editable-item" id="log-${log.id}">
                <span class="content"><strong>${displayDate}:</strong> ${log.content}</span>
                <div class="actions">
                    <button onclick="editLog('${log.id}', '${log.date}', \`${log.content}\`)">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button class="btn-danger" onclick="deleteLog('${log.id}')">‡∏•‡∏ö</button>
                </div>
            </div>`;
    }

    // --- Action Functions ---
    document.getElementById('addClassBtn').onclick = async () => {
        const className = document.getElementById('newClassName').value;
        const schedule = document.getElementById('newSchedule').value;
        if (!className) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏≤‡∏™');
        const newClass = await callGAS('addClass', { className, schedule });
        if (newClass) {
            ALL_CLASSES_DATA.push(newClass);
            renderClassList();
            document.getElementById('newClassName').value = '';
            document.getElementById('newSchedule').value = '';
        }
    };

    async function updateSchedule(classId) {
        const schedule = document.getElementById(`schedule-${classId}`).value;
        await callGAS('updateClassSchedule', { classId, schedule });
        ALL_CLASSES_DATA.find(c => c.classId === classId).schedule = schedule;
        alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
    }

    // --- Student Actions ---
    async function addStudent(classId) {
        const input = document.getElementById(`newStudentName-${classId}`);
        const studentName = input.value.trim();
        if (!studentName) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');
        const newStudent = await callGAS('addStudent', { classId, studentName });
        if (newStudent) {
            ALL_CLASSES_DATA.find(c => c.classId === classId).students.push(newStudent);
            document.getElementById(`student-list-${classId}`).insertAdjacentHTML('beforeend', renderStudentItem(newStudent));
            input.value = '';
        }
    }

    async function deleteStudent(studentId) {
        if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ?')) return;
        await callGAS('deleteStudent', { studentId });
        document.getElementById(`student-${studentId}`).remove();
        const classData = ALL_CLASSES_DATA.find(c => c.classId === currentClassId);
        classData.students = classData.students.filter(s => s.id !== studentId);
    }

    function editStudent(studentId, currentName) {
        const newName = prompt('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:', currentName);
        if (newName && newName.trim() !== currentName) {
            updateStudent(studentId, newName.trim());
        }
    }

    async function updateStudent(studentId, newName) {
        await callGAS('updateStudent', { studentId, newName });
        document.querySelector(`#student-${studentId} .content`).textContent = newName;
        const classData = ALL_CLASSES_DATA.find(c => c.classId === currentClassId);
        classData.students.find(s => s.id === studentId).name = newName;
    }


    // --- Log Actions ---
    async function addLog(classId) {
        const dateInput = document.getElementById(`newLogDate-${classId}`);
        const contentInput = document.getElementById(`newLogContent-${classId}`);
        const logDate = dateInput.value;
        const logContent = contentInput.value.trim();
        if (!logDate || !logContent) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤');
        const newLog = await callGAS('addTeachingLog', { classId, logDate, logContent });
        if (newLog) {
            ALL_CLASSES_DATA.find(c => c.classId === classId).logs.push(newLog);
            document.getElementById(`log-list-${classId}`).insertAdjacentHTML('afterbegin', renderLogItem(newLog));
            dateInput.value = '';
            contentInput.value = '';
        }
    }

    async function deleteLog(logId) {
        if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏ô‡∏µ‡πâ?')) return;
        await callGAS('deleteLog', { logId });
        document.getElementById(`log-${logId}`).remove();
        const classData = ALL_CLASSES_DATA.find(c => c.classId === currentClassId);
        classData.logs = classData.logs.filter(l => l.id !== logId);
    }

    function editLog(logId, currentDate, currentContent) {
        const itemDiv = document.getElementById(`log-${logId}`);
        const originalHTML = itemDiv.innerHTML;
        itemDiv.innerHTML = `
            <div style="width: 100%;">
                <input type="date" value="${currentDate}" style="margin-bottom: 5px;">
                <textarea style="min-height: 80px;">${currentContent}</textarea>
                <button class="btn-save">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button class="btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        `;
        itemDiv.querySelector('.btn-save').onclick = () => {
            const newDate = itemDiv.querySelector('input').value;
            const newContent = itemDiv.querySelector('textarea').value;
            updateLog(logId, newDate, newContent);
        };
        itemDiv.querySelector('.btn-secondary').onclick = () => {
            itemDiv.innerHTML = originalHTML;
        };
    }

    async function updateLog(logId, newDate, newContent) {
        await callGAS('updateLog', { logId, logDate: newDate, logContent: newContent });
        const classData = ALL_CLASSES_DATA.find(c => c.classId === currentClassId);
        const log = classData.logs.find(l => l.id === logId);
        log.date = newDate;
        log.content = newContent;
        document.getElementById(`log-${logId}`).outerHTML = renderLogItem(log);
    }
</script>

</body>
</html>
